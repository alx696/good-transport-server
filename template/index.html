<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>里路好传</title>
    <style>
        * {
            font-family: "Noto Serif CJK SC", "Noto Sans CJK SC", sans-serif;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0;
            display: grid;
            grid-template-rows: auto 1fr auto;
            font-size: 1rem;
            background-color: black;
        }

        button {
            padding: 1rem;
            font-size: 1rem;
        }

        body>header {
            padding: 1rem;
            background-color: #333333;
            position: relative;
        }

        body>header>div.dropTips {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(255, 100, 100, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        body>header>div.dropTipsShow {
            display: flex;
        }

        body>header textarea {
            box-sizing: border-box;
            width: 100%;
            padding: 1rem;
            resize: vertical;
        }

        body>div {
            overflow: auto;
        }

        body>footer {
            padding: 1rem;
            text-align: center;
            background-color: #eeeeee;
        }

        .item {
            border-bottom: 1px solid #666666;
            padding: 1rem;
            color: #cccccc;
        }

        .item>header {
            font-weight: bold;
        }

        .item>.progress {
            margin-top: 2rem;
            height: 1rem;
            background-color: orange;
        }

        .item>.progress>div {
            width: 0;
            height: 100%;
            background-color: green;
        }
    </style>
    <script>
        // https://filesizejs.com/
        !function (i, t) { "object" == typeof exports && "undefined" != typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define(t) : (i = "undefined" != typeof globalThis ? globalThis : i || self).filesize = t() }(this, (function () { "use strict"; function i(t) { return i = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (i) { return typeof i } : function (i) { return i && "function" == typeof Symbol && i.constructor === Symbol && i !== Symbol.prototype ? "symbol" : typeof i }, i(t) } var t = "array", o = "bits", e = "byte", n = "bytes", r = "", b = "exponent", l = "function", a = "iec", d = "Invalid number", f = "Invalid rounding method", u = "jedec", s = "object", c = ".", p = "round", y = "kbit", m = "string", v = { symbol: { iec: { bits: ["bit", "Kibit", "Mibit", "Gibit", "Tibit", "Pibit", "Eibit", "Zibit", "Yibit"], bytes: ["B", "KiB", "MiB", "GiB", "TiB", "PiB", "EiB", "ZiB", "YiB"] }, jedec: { bits: ["bit", "Kbit", "Mbit", "Gbit", "Tbit", "Pbit", "Ebit", "Zbit", "Ybit"], bytes: ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"] } }, fullform: { iec: ["", "kibi", "mebi", "gibi", "tebi", "pebi", "exbi", "zebi", "yobi"], jedec: ["", "kilo", "mega", "giga", "tera", "peta", "exa", "zetta", "yotta"] } }; function g(g) { var h = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : {}, B = h.bits, M = void 0 !== B && B, S = h.pad, T = void 0 !== S && S, w = h.base, x = void 0 === w ? -1 : w, E = h.round, j = void 0 === E ? 2 : E, N = h.locale, P = void 0 === N ? r : N, k = h.localeOptions, G = void 0 === k ? {} : k, K = h.separator, Y = void 0 === K ? r : K, Z = h.spacer, z = void 0 === Z ? " " : Z, I = h.symbols, L = void 0 === I ? {} : I, O = h.standard, q = void 0 === O ? r : O, A = h.output, C = void 0 === A ? m : A, D = h.fullform, F = void 0 !== D && D, H = h.fullforms, J = void 0 === H ? [] : H, Q = h.exponent, R = void 0 === Q ? -1 : Q, U = h.roundingMethod, V = void 0 === U ? p : U, W = h.precision, X = void 0 === W ? 0 : W, $ = R, _ = Number(g), ii = [], ti = 0, oi = r; -1 === x && 0 === q.length ? (x = 10, q = u) : -1 === x && q.length > 0 ? x = (q = q === a ? a : u) === a ? 2 : 10 : q = 10 === (x = 2 === x ? 2 : 10) || q === u ? u : a; var ei = 10 === x ? 1e3 : 1024, ni = !0 === F, ri = _ < 0, bi = Math[V]; if (isNaN(g)) throw new TypeError(d); if (i(bi) !== l) throw new TypeError(f); if (ri && (_ = -_), (-1 === $ || isNaN($)) && ($ = Math.floor(Math.log(_) / Math.log(ei))) < 0 && ($ = 0), $ > 8 && (X > 0 && (X += 8 - $), $ = 8), C === b) return $; if (0 === _) ii[0] = 0, oi = ii[1] = v.symbol[q][M ? o : n][$]; else { ti = _ / (2 === x ? Math.pow(2, 10 * $) : Math.pow(1e3, $)), M && (ti *= 8) >= ei && $ < 8 && (ti /= ei, $++); var li = Math.pow(10, $ > 0 ? j : 0); ii[0] = bi(ti * li) / li, ii[0] === ei && $ < 8 && -1 === R && (ii[0] = 1, $++), oi = ii[1] = 10 === x && 1 === $ ? M ? y : "kB" : v.symbol[q][M ? o : n][$] } if (ri && (ii[0] = -ii[0]), X > 0 && (ii[0] = ii[0].toPrecision(X)), ii[1] = L[ii[1]] || ii[1], !0 === P ? ii[0] = ii[0].toLocaleString() : P.length > 0 ? ii[0] = ii[0].toLocaleString(P, G) : Y.length > 0 && (ii[0] = ii[0].toString().replace(c, Y)), T && !1 === Number.isInteger(ii[0]) && j > 0) { var ai = Y || c, di = ii[0].toString().split(ai), fi = di[1] || r, ui = fi.length, si = j - ui; ii[0] = "".concat(di[0]).concat(ai).concat(fi.padEnd(ui + si, "0")) } return ni && (ii[1] = J[$] ? J[$] : v.fullform[q][$] + (M ? "bit" : e) + (1 === ii[0] ? r : "s")), C === t ? ii : C === s ? { value: ii[0], symbol: ii[1], exponent: $, unit: oi } : ii.join(z) } return g.partial = function (i) { return function (t) { return g(t, i) } }, g }));

        // 开发时可以指定测试地址, 例如 http://192.168.1.3:19617
        const TARGET = '';

        const Tool = {
            html(htmlText) {
                let template = document.createElement('template');
                template.innerHTML = htmlText;
                return template.content.firstChild;
            },

            close() {
                if (window.AlipayJSBridge) {
                    // 支付宝
                    AlipayJSBridge.call('exitApp');
                } else if (window.WeixinJSBridge) {
                    // 微信
                    WeixinJSBridge.call('closeWindow');
                } else if (window.wx) {
                    // 微信
                    wx.exitMiniProgram();
                }
            },

            /**
             * 上传
             * @param file 原生文件对象
             * @param onProgress (uploadSize, fileSize, percentage) => {}
             * @param onDone () => {}
             * @param onError (error) => {}
             */
            upload(file, onProgress, onDone, onError) {
                const blockLength = 1024 * 1024; // 每块字节数量
                let finishLength = 0; // 已经完成字节数量

                // 上传数据
                const uploadData = (fileId) => {
                    // 获取下一个块
                    const block = file.slice(
                        finishLength,
                        finishLength + blockLength
                    );

                    // 注意: 支付宝内嵌的UC中这个不会执行, 不让自动fetch?!
                    const formData = new FormData();
                    formData.set('file_id', fileId);
                    formData.set('file_block', block);
                    fetch(
                        `${TARGET}/upload/block`,
                        {
                            method: 'POST',
                            body: formData,
                            cache: 'no-cache'
                        }
                    )
                        .then(response => {
                            if (response.status !== 200) {
                                onError(`发送失败: ${response.status}`);
                                return;
                            }

                            finishLength += block.size;

                            onProgress(
                                finishLength,
                                file.size,
                                parseInt(parseFloat((finishLength / file.size).toFixed(2)) * 100)
                            );

                            if (finishLength === file.size) {
                                onDone();

                                return;
                            }

                            uploadData(fileId);
                        })
                        .catch((error) => {
                            onError(
                                String(error)
                            );
                        });
                };

                // 开始上传
                const uploadStart = () => {
                    return new Promise((resolve, reject) => {
                        const formData = new FormData();
                        formData.set('file_name', file.name);
                        formData.set('file_size', file.size);

                        fetch(
                            `${TARGET}/upload/start`,
                            {
                                method: 'POST',
                                body: formData
                            }
                        )
                            .then(response => {
                                response.text()
                                    .then(text => {
                                        if (response.status === 200) {
                                            resolve(text);
                                        } else {
                                            reject(text);
                                        }
                                    });
                            })
                            .catch(reject);
                    });
                };
                uploadStart()
                    .then(id => {
                        uploadData(id);
                    })
                    .catch((error) => {
                        onError(
                            String(error)
                        );
                    });
            },

            /**
             * 上传
             * @param text 文本
             */
            sendText(text) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.set('text', text);

                    fetch(
                        `${TARGET}/text`,
                        {
                            method: 'POST',
                            body: formData
                        }
                    )
                        .then(response => {
                            response.text()
                                .then(text => {
                                    if (response.status === 200) {
                                        resolve(text);
                                    } else {
                                        reject(text);
                                    }
                                });
                        })
                        .catch(reject);
                });
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const headerElement = document.querySelector('body > header');
            const headerDropTipsElement = document.querySelector('body > header > div.dropTips');
            const listElement = document.body.querySelector('#list');
            const fileElement = document.body.querySelector('#file');
            const textElement = document.body.querySelector('#text');
            const sendTextElement = document.body.querySelector('#sendText');

            const sendFile = (file) => {
                const itemElement = Tool.html(`<section class="item">
    <header>${file.name}</header>
    <div class="info" data-ui="info">文件 ${filesize(file.size)}</div>
    <div class="progress">
        <div data-ui="finishSize"></div>
    </div>
</section>`);
                const itemElementInfo = itemElement.querySelector('[data-ui="info"]');
                const itemElementFinishSize = itemElement.querySelector('[data-ui="finishSize"]');
                listElement.append(itemElement);

                Tool.upload(
                    file,
                    (uploadSize, fileSize, percentage) => {
                        // console.debug('上传进度', uploadSize, fileSize, percentage);
                        itemElementFinishSize.style.width = `${percentage}%`;
                    },
                    () => {
                        console.info('文件发送完毕');
                    },
                    (error) => {
                        console.warn('文件发送错误', error);
                        itemElementInfo.textContent = `发送失败: ${error}`;
                    }
                );
            };

            fileElement.addEventListener('click', () => {
                // 支付宝自带UC不能执行上传文件块的fetch!
                if (window.AlipayJSBridge) {
                    alert('支付宝自带浏览器存在问题无法正常发送文件, 请复制链接后用专门的浏览器打开! 推荐使用Chrome, 以获得最佳体验.');
                    return;
                }

                const inputElement = Tool.html(`<input type="file" style="display: none;">`);
                document.body.append(inputElement);

                inputElement.addEventListener('change', () => {
                    for (const file of inputElement.files) {
                        console.debug('选择文件', file);
                        sendFile(file);
                    }
                });
                inputElement.click();
            });

            sendTextElement.addEventListener('click', () => {
                const text = textElement.value;

                if (text === '') {
                    alert('没有粘贴文本');
                    return;
                }

                const itemElement = Tool.html(`<section class="item">
    <header>${text}</header>
    <div class="info" data-ui="info">文本 ${text.length}字符</div>
    <div class="progress">
        <div data-ui="finishSize"></div>
    </div>
</section>`);
                const itemElementInfo = itemElement.querySelector('[data-ui="info"]');
                const itemElementFinishSize = itemElement.querySelector('[data-ui="finishSize"]');
                listElement.append(itemElement);

                Tool.sendText(text)
                    .then(() => {
                        console.info('文本发送完毕');
                        itemElementFinishSize.style.width = `100%`;
                    }),
                    (error) => {
                        console.warn('文本发送错误', error);
                        itemElementInfo.textContent = `发送失败: ${error}`;
                    };
            });

            // 拖放文件
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            headerElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (!headerDropTipsElement.classList.contains('dropTipsShow')) {
                    headerDropTipsElement.classList.add('dropTipsShow');
                }
            });
            headerDropTipsElement.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (headerDropTipsElement.classList.contains('dropTipsShow')) {
                    headerDropTipsElement.classList.remove('dropTipsShow');
                }
            });
            headerElement.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (headerDropTipsElement.classList.contains('dropTipsShow')) {
                    headerDropTipsElement.classList.remove('dropTipsShow');
                }

                for (const file of e.dataTransfer.files) {
                    console.debug('拖放文件: ', file);
                    sendFile(file);
                }
            });
        });
    </script>
</head>

<body>

    <header>
        <div>
            <textarea id="text" placeholder="粘贴文本" rows="6"></textarea>
        </div>
        <div>
            <button id="sendText">发送文本</button>
            <button id="file">选择并发送文件</button>
        </div>

        <div class="dropTips">松开发送拖动的文件</div>
    </header>
    <div>
        <article id="list">
            <!--        <section class="item">-->
            <!--            <header>文件名称</header>-->
            <!--            <div class="info">300MB</div>-->
            <!--            <div class="progress">-->
            <!--                <div style="width: 60%;"></div>-->
            <!--            </div>-->
            <!--        </section>-->
        </article>
    </div>
    <footer>访问网站 <a href="https://lilu.red/" target="_blank">lilu.red</a> 探索更多好玩的技术</footer>

</body>

</html>
